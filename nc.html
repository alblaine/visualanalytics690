<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <title>NC Map example</title>
    <style>
        #canvas {
            width:960px;
            height:800px;
            margin:0 auto;
            border:1px solid #ccc;
        }
    
    </style>
<body>
    <select id="drg-code"></select>
    <div id="canvas"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.js"></script>
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script>
        var width = 960,
            height = 800;
            
        var x = d3.scale.linear()
            .domain([0, width])
            .range([0, width]);

        var y = d3.scale.linear()
            .domain([0, height])
            .range([height, 0]);
    
        //maybe use a different projection to rotate the map appropriately
        var projection = d3.geo.albers()
                            .scale(7700)
                            .rotate([91, 1, -6])
                            .translate([-width * 1.31, 0]);

        var path = d3.geo.path().projection(projection);
        
        var zoom = d3.behavior.zoom()
                    .x(x)
                    .y(y)
                    //.translate([0, 0])
                    //.scale(1)
                    .scaleExtent([1, 8])
                    .on("zoom", zoomed);
        
        //don't want to rotate SVG element because then all manipulations will be on an angle
        var svg = d3.select("#canvas").append("svg")
            .attr("width", width)
            .attr("height", height)
            .call(zoom);
        
        var drgSelect = $('#drg-code');
        
        var hospitals;
        
        function loadData(){
            d3.csv("data/inpatient_data_2012_nc_lat_long.csv", function(error, records){
                if (error) {
                    return console.error(error);
                }
                
                var nestedData = d3.nest().key(function(d){
                    return d["DRG Definition"];
                }).entries(records);
                
                var keys = nestedData.map(function(d){
                    return d.key;
                });
                
                $(keys).each(function(){
                    drgSelect.append('<option value="' + this + '">' + this +'</option>')
                });
                
                var firstCondition = keys[0];
                
                filteredRecords = records.filter(function(d){
                   return d["DRG Definition"] == firstCondition;
                });
                
                drgSelect.on("change", function(e){
                    var newDrg = e.target.value;
                    var filteredRecords = records.filter(function(d){
                        return d["DRG Definition"] == newDrg;
                    });
                    
                    showHospitals(filteredRecords);
                });
                
                showHospitals(filteredRecords);
            });
            
        }
        
        var counties;
        
        d3.json("nc-counties-topo.json", function(error, states) {
          if (error) {
            return console.error(error);
          }
          var topo = topojson.feature(states, states.objects.counties).features;
          
          counties = svg.selectAll(".county").data(topo);
          
          counties.enter().insert("path")
            .attr("class", "county")
            .attr("id", function(d, i){ return "county" + d.id; })
            .attr("d", path)
            .style("stroke", "#000")
            .style("fill", "#ccc");
            
            loadData();
        });
        
        function showHospitals(hospitals){
            hospitals = svg.selectAll(".hospital").data(hospitals);

            hospitals.enter().append("circle")
                .attr("class", "hospital")
                .attr("r", 3);

            hospitals.attr("transform", function(d) {
                    return "translate(" + projection([
                      d["Provider Longitude"],
                      d["Provider Latitude"]
                    ]) + ")"
                })
                .style("fill", "brown");
            
            hospitals.exit().remove();
        }
        
        function zoomed() {
            //console.log(zoom.translate(), zoom.scale());
            //if (d3.event) {
                projection
                    .translate(d3.event.translate)
                    .scale(d3.event.scale);
            //}
            //svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            counties.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            //hospitals.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            hospitals.attr("transform", function(d){
                var p = projection([d["Provider Longitude"], d["Provider Latitude"]]);
                //console.log(p);
                return "translate(" + p[0] + "," + p[1] + ")";
            });
        }
        

    </script>
</body>
</html>
