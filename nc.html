<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <title>NC Map example</title>
    <style>
        #canvas {
            width:960px;
            height:800px;
            margin:0 auto;
            border:1px solid #ccc;
        }
    
    </style>
<body>
    <div id="canvas"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/topojson.v1.js"></script>
    <script>
        var width = 960,
            height = 800;
        
        //don't want to rotate SVG element because then all manipulations will be on an angle
        var svg = d3.select("#canvas").append("svg")
            .attr("width", width)
            .attr("height", height);
    
        //maybe use a different projection to rotate the map appropriately
        var projection = d3.geo.albers()
                            .scale(5000)
                            .translate([-width/1.3, 0]);

        var path = d3.geo.path().projection(projection);
        
        function loadData(){
            d3.csv("data/inpatient_data_2012_nc_lat_long.csv", function(error, records){
                if (error) {
                    return console.error(error);
                }
                
                records = records.filter(function(d){
                   return d["DRG Definition"] == "039 - EXTRACRANIAL PROCEDURES W/O CC/MCC";
                });
                 
                var hospital = svg.selectAll(".hospital").data(records);
                
               
                
                hospital.enter().append("circle")
                    .attr("class", "hospital")
                    .attr("r", 3)
                    .style("fill", "brown")
                    .attr("transform", function(d) {
                        return "translate(" + projection([
                          d["Provider Longitude"],
                          d["Provider Latitude"]
                        ]) + ")"
                    });
            });
            
        }
        d3.json("nc-counties-topo.json", function(error, states) {
          if (error) {
            return console.error(error);
          }
          var topo = topojson.feature(states, states.objects.counties).features;
          
          var county = svg.selectAll(".county").data(topo);
          
          county.enter().insert("path")
            .attr("class", "county")
            .attr("id", function(d, i){ return "county" + d.id; })
            .attr("d", path)
            .style("stroke", "#000")
            .style("fill", "#ccc");
            
            loadData();
        });
        

    </script>
</body>
</html>
